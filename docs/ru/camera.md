# –†–∞–±–æ—Ç–∞ —Å –∫–∞–º–µ—Ä–æ–π

<!-- TODO: —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–º–µ—Ä–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ `~/catkin_ws/src/clover/clover/launch/clover.launch`:  $\color{red}{\textsf{üî¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è}}$

```xml
<arg name="main_camera" default="true"/>
```

–¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–∞–º–µ—Ä–∞ [—Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –¥–ª—è –Ω–µ–µ —É–∫–∞–∑–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è](camera_setup.md).

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ launch-—Ñ–∞–π–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–∫–µ—Ç `clover`: $\color{red}{\textsf{üî¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è}}$

```bash
sudo systemctl restart clover
```
$\color{red}{\textsf{üî¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è}}$

–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–∞–º–µ—Ä—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [rqt](rviz.md) –∏–ª–∏ [web_video_server](web_video_server.md).

## –ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏

–ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∫–∞–º–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–µ —Å –ø–æ–º–æ—â—å—é —É—Ç–∏–ª–∏—Ç—ã [`raspistill`](https://www.raspberrypi.org/documentation/usage/camera/raspicam/raspistill.md).

–û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã –ö–ª–µ–≤–µ—Ä–∞:

```bash
sudo systemctl stop clover
```
$\color{red}{\textsf{üî¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è}}$

–ü–æ–ª—É—á–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –∫–∞–º–µ—Ä—ã —É—Ç–∏–ª–∏—Ç–æ–π `raspistill`:

```bash
raspistill -o test.jpg
```

–ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —à–ª–µ–π—Ñ–∞ –∫–∞–º–µ—Ä—ã –∫ Raspberry Pi –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –µ–≥–æ.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã

–†—è–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–∞–º–µ—Ä—ã - —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —á–∞—Å—Ç–æ—Ç—É –∫–∞–¥—Ä–æ–≤, —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é - –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ —Ñ–∞–π–ª–µ `main_camera.launch`. –°–ø–∏—Å–æ–∫ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–∂–Ω–æ [–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ cv_camera](https://github.com/OTL/cv_camera#parameters).

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –Ω–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ —ç—Ç–æ–º —Å–ø–∏—Å–∫–µ, –º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ [–∫–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ OpenCV](https://docs.opencv.org/3.3.1/d4/d15/group__videoio__flags__base.html). –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –Ω–æ–¥—É –∫–∞–º–µ—Ä—ã:

```xml
<param name="property_0_code" value="21"/> <!-- property code 21 is CAP_PROP_AUTO_EXPOSURE -->
<param name="property_0_value" value="0.25"/> <!-- property values are normalized as per OpenCV specs, even for "menu" controls; 0.25 means "use manual exposure" -->
<param name="cv_cap_prop_exposure" value="0.3"/> <!-- set exposure to 30% of maximum value -->
```

## –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –Ω–∞ [–æ–±—Ä–∞–∑ SD-–∫–∞—Ä—Ç—ã](image.md) –±–∏–±–ª–∏–æ—Ç–µ–∫—É [OpenCV](https://opencv.org).

### Python

–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –Ω–∞ —Ç–æ–ø–∏–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–º–µ—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenCV:

```python
import rospy
import cv2
from sensor_msgs.msg import Image
from cv_bridge import CvBridge
from clover import long_callback

rospy.init_node('cv')
bridge = CvBridge()

@long_callback
def image_callback(data):
    img = bridge.imgmsg_to_cv2(data, 'bgr8')  # OpenCV image
    # Do any image processing with cv2...

image_sub = rospy.Subscriber('main_camera/image_raw', Image, image_callback)

rospy.spin()
```

> **Note** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è. –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å [–ø—Ä–æ–±–ª–µ–º—É](https://github.com/ros/ros_comm/issues/1901) –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ rospy, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–∞–¥—Ä–æ–≤ —Å –∫–∞–º–µ—Ä—ã. –î–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `long_callback` –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `clover`, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –≤—ã—à–µ. $\color{red}{\textsf{üî¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è}}$

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–ø–∏–∫–∞ `main_camera/image_raw` —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤ —Å –∫–∞–º–µ—Ä—ã, –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—è CPU (–≤–ø–ª–æ—Ç—å –¥–æ 100%). –í –∑–∞–¥–∞—á–∞—Ö, –≥–¥–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ø–∏–∫, –≥–¥–µ –∫–∞–¥—Ä—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —Å —á–∞—Å—Ç–æ—Ç–æ–π 5 –ì—Ü: `main_camera/image_raw_throttled`:

```python
image_sub = rospy.Subscriber('main_camera/image_raw_throttled', Image, image_callback, queue_size=1)
```

#### –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ —Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º:

```python
image_pub = rospy.Publisher('~debug', Image)
```

–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:

```python
image_pub.publish(bridge.cv2_to_imgmsg(img, 'bgr8'))
```

–ü–æ–ª—É—á–∞–µ–º—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑—É—è [web_video_server](web_video_server.md) –∏–ª–∏ [rqt](rviz.md).

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞

–°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–¥—Ä–∞ —Å –∫–∞–º–µ—Ä—ã. –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–ø–∏–∫; –µ–≥–æ –Ω–µ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ —Å–ª—É—á–∞–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

```python
import rospy
from sensor_msgs.msg import Image
from cv_bridge import CvBridge

rospy.init_node('cv')
bridge = CvBridge()

# ...

# Retrieve a frame:
img = bridge.imgmsg_to_cv2(rospy.wait_for_message('main_camera/image_raw', Image), 'bgr8')
```

### –ü—Ä–∏–º–µ—Ä—ã

#### –†–∞–±–æ—Ç–∞ —Å QR-–∫–æ–¥–∞–º–∏

> **Hint** –î–ª—è –≤—ã—Å–æ–∫–æ—Å–∫–æ—Ä–æ—Å—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [ArUco-–º–∞—Ä–∫–µ—Ä—ã](aruco.md).

–î–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∫–æ–ø—Ç–µ—Ä–∞ –ø—Ä–∏ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω—É–∂–Ω—ã—Ö [QR-–∫–æ–¥–æ–≤](https://ru.wikipedia.org/wiki/QR-–∫–æ–¥) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É [pyZBar](https://pypi.org/project/pyzbar/). –û–Ω–∞ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ–±—Ä–∞–∑–µ –¥–ª—è Raspberry Pi.

–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤ –Ω–∞ Python:

```python
import rospy
from pyzbar import pyzbar
import cv2
from cv_bridge import CvBridge
from sensor_msgs.msg import Image
from clover import long_callback

rospy.init_node('cv')
bridge = CvBridge()

@long_callback
def image_callback(msg):
    img = bridge.imgmsg_to_cv2(msg, 'bgr8')
    barcodes = pyzbar.decode(img)
    for barcode in barcodes:
        b_data = barcode.data.decode('utf-8')
        b_type = barcode.type
        (x, y, w, h) = barcode.rect
        xc = x + w/2
        yc = y + h/2
        print('Found {} with data {} with center at x={}, y={}'.format(b_type, b_data, xc, yc))

image_sub = rospy.Subscriber('main_camera/image_raw_throttled', Image, image_callback, queue_size=1)

rospy.spin()
```

## –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ

–î–ª—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –Ω–æ–¥–∞ [`video_recorder`](http://wiki.ros.org/image_view#image_view.2Fdiamondback.video_recorder) –∏–∑ –ø–∞–∫–µ—Ç–∞ `image_view`:

```bash
rosrun image_view video_recorder image:=/main_camera/image_raw
```

–í–∏–¥–µ–æ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Ñ–∞–π–ª `output.avi`. –í –∞—Ä–≥—É–º–µ–Ω—Ç–µ `image` —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ.
